---
title: TCP/IP协议——ARP详解
date: 2009-06-01 08:00:00
updated: 2009-06-01 08:00:00
tags: "arp"
categories: ["Network", "Protocol"]
---

本文主要讲述了 ARP 的作用、ARP 分组格式、ARP 高速缓存、免费 ARP 和代理 ARP。

<!-- more -->

## 学习 ARP 前要了解的内容

### 建立 TCP 连接与 ARP 的关系

应用接受用户提交的数据，触发 TCP 建立连接，TCP 的第一个 SYN 报文通过 connect 函数到达 IP 层，IP 层通过查询路由表：

- 如果目的 IP 和自己在同一个网段：

  - 当 IP 层的 ARP 高速缓存表中存在目的 IP 对应的 MAC 地址时，则调用网络接口 send 函数（参数为 IP Packet 和目的 MAC））将数据提交给网络接口，网络接口完成 Ethernet Header + IP + CRC 的封装，并发送出去；

  - 当 IP 层的 ARP 高速缓存表中不存在目的 IP 对应的 MAC 地址时，则 IP 层将 TCP 的 SYN 缓存下来，发送 ARP 广播请求目的 IP 的 MAC，收到 ARP 应答之后，将应答之中的<IP 地址，对应的 MAC>对缓存在本地 ARP 高速缓存表中，然后完成 TCP SYN 的 IP 封装，调用网络接口 send 函数（参数为 IP Packet 和目的 MAC））将数据提交给网络接口，网络接口完成 Ethernet Header + IP + CRC 的封装，并发送出去；。

- 如果目的 IP 地址和自己不在同一个网段，就需要将包发送给默认网关，这需要知道默认网关的 MAC 地址：

  - 当 IP 层的 ARP 高速缓存表中存在默认网关对应的 MAC 地址时，则调用网络接口 send 函数（参数为 IP Packet 和默认网关的 MAC）将数据提交给网络接口，网络接口完成 Ethernet Header + IP + CRC

  - 当 IP 层的 ARP 高速缓存表中不存在默认网关对应的 MAC 地址时，则 IP 层将 TCP 的 SYN 缓存下来，发送 ARP 广播请求默认网关的 MAC，收到 ARP 应答之后，将应答之中的<默认网关地址，对应的 MAC>对缓存在本地 ARP 高速缓存表中，然后完成 TCP SYN 的 IP 封装，调用网络接口 send 函数（参数为 IP Packet 和默认网关的 MAC）将数据提交给网络接口，网络接口完成 Ethernet Header + IP + CRC 的封装，并发送出去。

### ARP 的位置

OSI 模型有七层，TCP 在第 4 层传输层，IP 在第 3 层网络层，而 ARP 在第 2 层数据链路层。高层对低层是有强依赖的，所以 TCP 的建立前要进行 ARP 的请求和应答。

ARP 高速缓存表在 IP 层使用。如果每次建立 TCP 连接都发送 ARP 请求，会降低效率，因此在主机、交换机、路由器上都会有 ARP 缓存表。建立 TCP 连接时先查询 ARP 缓存表，如果有效，直接读取 ARP 表项的内容进行第二层数据包的发送；只有表失效时才进行 ARP 请求和应答进行 MAC 地址的获取，以建立 TCP 连接。

### ARP 的作用

要了解 ARP 的作用，首先要分清两个“地址”：

1. TCP/IP 的 32bit IP 地址。仅知道主机的 IP 地址不能让内核发送数据帧给主机。

2. 网络接口的硬件地址，它是一个 48bit 的值，用来标识不同的以太网或令牌环网络接口。在硬件层次上，进行数据交换必须有正确的接口地址，内核必须知道目的端的硬件地址才能发送数据。

简言之，就是在以太网中，一台主机要把数据帧发送到同一局域网上的另一台主机时，设备驱动程序必须知道以太网地址才能发送数据。而我们只知道 IP 地址，这时就需要采用 ARP 协议将 IP 地址映射为以太网地址。

要注意一点，一般认为 ARP 协议只使适用于局域网。

## ARP 分组格式

ARP 分组的格式如下图：

![](https://images2015.cnblogs.com/blog/802212/201611/802212-20161126102714893-597098126.png)

先要清楚，一般说**以太网地址就是指 MAC 地址**。

- 字段 1 是 ARP 请求的目的以太网地址，全 1 时代表广播地址。
- 字段 2 是发送 ARP 请求的以太网地址。
- 字段 3 以太网帧类型表示的是后面的数据类型，ARP 请求和 ARP 应答这个值为 0x0806。
- 字段 4 表示硬件地址的类型，硬件地址不只以太网一种，是以太网类型时此值为 1。
- 字段 5 表示要映射的协议地址的类型，要对 IPv4 地址进行映射，此值为 0x0800。
- 字段 6 和 7 表示硬件地址长度和协议地址长度，MAC 地址占 6 字节，IP 地址占 4 字节。
- 字段 8 是操作类型字段，值为 1，表示进行 ARP 请求；值为 2，表示进行 ARP 应答；值为 3，表示进行 RARP 请求；值为 4，表示进行 RARP 应答。
- 字段 9 是发送端 ARP 请求或应答的硬件地址，这里是以太网地址，和字段 2 相同。
- 字段 10 是发送 ARP 请求或应答的 IP 地址。
- 字段 11 和 12 是目的端的硬件地址和协议地址。

下面是抓取的 ARP 数据包，可以对照上面的说明进行理解。

图中红框圈起来的是一对 ARP 请求和 ARP 应答。

![](https://images2015.cnblogs.com/blog/802212/201611/802212-20161126102146893-49545375.png)

下面两张图分别是 ARP 请求和相应的 ARP 应答的分组格式截图。

ARP 请求分组中，字段 11 目的 MAC 地址未知，用全 0 进行填充。

![](https://images2015.cnblogs.com/blog/802212/201611/802212-20161126111221659-1104961836.png)

ARP 应答分组中，将 ARP 请求中的源和目的地址进行交换，此外，变化的还有字段 8 Opcode。其余字段内容不会发生变化。

![](https://images2015.cnblogs.com/blog/802212/201611/802212-20161126111229706-1754966155.png)

那么我们是如何区分 ARP 请求和 ARP 应答分组的呢？

分组中的地址字段和其他相同的字段无法作为区分依据，这时 Opcode 字段就发挥了作用，根据 Opcode 的值可以确定是请求还是应答，是 ARP 还是 RARP。

## ARP 高速缓存

### 定义

ARP 缓存是一个缓冲区，用来储存 IP 地址和 MAC 地址，本质就是<IP 地址，MAC 地址>的对应表。表中一个条目记录了网络上一个主机的 IP 地址和其对应的 MAC 地址。

每一个以太网或令牌环网络适配器都有自己单独的表。

当地址解析协议被询问一个已知 IP 地址节点的 MAC 地址时，先在 ARP 缓存中查看，若存在，就直接返回与之对应的 MAC 地址，若不存在，才发送 ARP 请求向局域网查询。

### ARP 缓存表项的生存时间 TTL

ARP 缓存包含动态和静态项目：

动态项目随时间推移自动添加和删除，每个动态 ARP 缓存项都有都设置了 TTL(生存时间)，TTL 为 0 时此项目就从表中删除，Windows 下 TTL 一般不超过 10 分钟。

静态 ARP 缓存条目是永久性的，可以使用 TCP/IP 工具手动添加和删除。静态 ARP 缓存条目用来禁止节点发送对常用的本地 IPv4 地址（例如路由器和服务器的 IPv4 地址）的 ARP 请求。

### ARP 高速缓存的使用

当主机发送一个 ARP 请求时，先查看 ARP 高速缓存表，如果存在对应条目，则直接返回 MAC 地址，否则向局域网发送 ARP 请求广播。

### ARP 高速缓存的优缺点

优点：从 ARP 高速缓存的使用中可以看到，ARP 高速缓存可以减小广播量，进而减小网络通信量，提高计算机之间的通信效率。

缺点：造成安全隐患（参考下面免费 ARP 的作用）。

## 免费 ARP

### 定义

免费 ARP 指主机发送 ARP 查找自己的 IP 地址，通常发生在系统引导期间进行接口配置时。

与标准 ARP 的区别就是免费 ARP 分组的目的 IP 地址字段封装的是自己的 IP 地址，即向所在网络请求自己的 MAC 地址。

### 作用

免费 ARP 的作用有：

1. 一个主机可以通过它来确定另一个主机是否设置了相同的 IP 地址。

   正常情况下发送免费 ARP 请求不会收到 ARP 应答，如果收到了一个 ARP 应答，则说明网络中存在与本机相同的 IP 地址的主机，发生了地址冲突。

2. 更新其他主机高速缓存中旧的硬件地址进行。

   如果发送免费 ARP 的主机正好改变了硬件地址，如更换了接口卡。

   其他主机接收到这个 ARP 请求的时候，发现自己的 ARP 高速缓存表中存在对应的 IP 地址，但是 MAC 地址不匹配，那么就需要利用接收的 ARP 请求来更新本地的 ARP 高速缓存表表项。

3. 网关利用免费 ARP 防止 ARP 攻击

   有些网关设备在一定的时间间隔内向网络主动发送免费 ARP 报文，让网络内的其他主机更新 ARP 表项中的网关 MAC 地址信息，以达到防止或缓解 ARP 攻击的效果。

4. 利用免费 ARP 进行 ARP 攻击

   ARP 协议并不只在发送了 ARP 请求才接收 ARP 应答，计算机只要接收到 ARP 应答数据包，就会使用应答中的 IP 和 MAC 地址对本地的 ARP 缓存进行更新。

   主机可以构造虚假的免费 ARP 应答，将 ARP 的源 MAC 地址设为错误的 MAC 地址，并把这个虚假的免费 ARP 应答发送到网络中，那么所有接收到这个免费 ARP 应答的主机都会更新本地 ARP 表项中相应 IP 地址对应的 MAC 地址。更新成功后，这些主机的数据报文就会被转发到错误的 MAC 地址，从而实现了 ARP 欺骗的攻击。

## 5.代理 ARP

### 定义

代理 ARP 就是通过使用一个主机(通常为 router)，来作为指定的设备使用自己的 MAC 地址来对另一设备的 ARP 请求作出应答。

### 为什么需要代理 ARP？

先要了解，路由器的重要功能之一就是把局域网的广播包限制在该网内，阻止其扩散，否则会造成网络风暴。

ARP 请求是个广播包，它询问的对象如果在同一个局域网内，就会收到应答。但是如果询问的对象不在同一个局域网该如何处理？路由器就提供的代理 ARP 为这个问题提供了解决方案。

### 工作过程

两台主机 A 和 B 处于同一网段但不同的广播段时，主机 A 发送 ARP 请求主机 B 的 MAC 地址时，因为路由器不转发广播包的原因，ARP 请求只能到达路由器。如果路由器启用了代理 ARP 功能，并知道主机 B 属于它连接的网络，那么路由器就用自己接口的 MAC 地址代替主机 B 的 MAC 地址来对主机 A 进行 ARP 应答。主机 A 接收 ARP 应答，但并不知道代理 ARP 的存在。

### 代理 ARP 的优缺点

优点：代理 ARP 能在不影响路由表的情况下添加一个新的 Router，使子网对该主机变得透明化。一般代理 ARP 应该使用在主机没有配置默认网关或没有任何路由策略的网络上。

缺点：从工作工程可以看到，这其实是一种 ARP 欺骗。而且，通过两个物理网络之间的路由器的代理 ARP 功能其实互相隐藏了物理网络，这导致无法对网络拓扑进行网络概括。此外，代理 ARP 增加了使用它的那段网络的 ARP 流量，主机需要更大的 ARP 缓存空间，也不会为不使用 ARP 进行地址解析的网络工作。
